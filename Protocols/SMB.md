# 概要

ポート445番を利用し、ファイル共有、プリンター共有、名前付きパイプ提供などに使われるプロトコル。
## 主な用途

ネットワーク上の他のコンピュータのファイルやプリンタを、自分のローカルにあるかのように扱ったり、ダウンロードしたりできる。

## 利点

ネットワークドライブのマウントやオフィスの共有プリンタを実現可能とする。
AD環境では、認証やグループポリシーの配布にも関わる。


# 基本情報

## バージョン

### SMBv1
非常に古い。深刻な脆弱性（[CVE-2017-0144](https://www.cve.org/CVERecord?id=CVE-2017-0144) "EternalBlue"）が存在するため、決して利用しない。
### SMBv2
v1から大幅改良され、セキュリティとパフォーマンスが上昇。
### SMBv3
2025-10-27現在、最新バージョン。
暗号化通信や、MITM耐性などが強化されている。

## 認証方式

### NTLM（New Technology LAN Manager）
古典的な認証方式。パスワードから生成したNTLMハッシュを用いた「チャレンジ/レスポンス認証」を行う。
ハッシュさえ手に入れば、パスワードがなくても突破可能（Pass-the-Hash攻撃）。

### Kerberos
AD環境での標準認証方式。
NTLMよりも安全とされるが、Kerberoastingなどの脆弱性が知られている。


# 詳細情報

## Nullセッション
[[# オプション|-Nオプション]]を使用する事で、ユーザー名やパスワードを指定せず匿名接続できることがある。

## 認証攻撃

### Pass-the-Hash
認証に利用される、パスワードのNTLMハッシュをコマンドで直接
指定することで、認証を突破できる。mimikaztでメモリ上から
ハッシュを摂取した場合など。

### NTLMリレー
victimとファイルサーバーの通信を中継し、チャレンジ/レスポンスを中継することで認証を突破するMITM攻撃。
victimがドメイン管理者であればroot権限が得られる。

# 主なコマンド

## smb-cliのコマンド

### 基本コマンド
```smb-cli -L //[IPアドレス] -U [ユーザー名]```（リスト表示）

```smb-cli //[IPアドレス]/[共有名] -U [ユーザー名]```（アクセス）

### オプション

```-L```　リスト表示を有効にする

```-U```　ユーザー名を指定する

```-N```　Nullセッションを試みる。ユーザー名は空文字列にする。

## 対話モードのコマンド

```help```　利用可能なコマンドのリスト

```ls``` または ```dir```　ディレクトリ内ファイルの列挙

```cd```　ディレクトリの移動

```get```　指定したファイルのダウンロード

```put```　書き込み権限のもとで、ファイルのアップロード

```mget``` または```mput```　ワイルドカードを用い、複数ファイルを操作

```rm```　削除権限のもとで、ファイルを削除

```exit``` または ```quit```　対話モードを退出